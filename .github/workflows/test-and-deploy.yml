name: Test and deploy
on: [push, pull_request]

env:
  # Version required to run itwÃªwina:
  ACTIONS_PYTHON_VERSION: 3.9
  # Version required to run npm build:
  ACTIONS_NODE_VERSION: 12
  # Version running on Sapir:
  ACTIONS_OS_VERSION: ubuntu-16.04
  # N.B.: Currently available versions (2021-01-04) are:
  #   - ubuntu-16.04
  #   - ubuntu-18.04 (@ubuntu-latest)
  #   - ubuntu-20.04 (soon-to-be @ubuntu-latest)
  # See: https://docs.github.com/en/free-pro-team@latest/actions/reference/workflow-syntax-for-github-actions#jobsjob_idruns-on

jobs:
  # Skips deploy if [skip deploy] is present in the commit message
  should-deploy:
    runs-on: ubuntu-20.04

    outputs:
      should-run: ${{ steps.ci-skip.outputs.ci-skip-not }}

    if: github.ref == 'refs/heads/master'
    steps:
    - uses: actions/checkout@v2
      with:
        # ci-skip needs to do a partial checkout
        fetch-depth: '0'
    - id: ci-skip
      uses: mstachniuk/ci-skip@v1
      with:
        commit-filter: '[skip deploy]'

  # Run Pytest unit tests
  unit-test:
    runs-on: ubuntu-16.04

    steps:
    - uses: actions/checkout@v2
    - name: ðŸ Set up Python ${{ env.ACTIONS_PYTHON_VERSION }}
      uses: actions/setup-python@v2
      with:
        python-version: ${{ env.ACTIONS_PYTHON_VERSION }}
    - name: ðŸ–¥ Install system dependencies
      run: sudo apt-get install -y libfoma0
    - name: â˜¤ Install pipenv
      run: python3 -m pip install pipenv

    # This started out life as a copy-paste from
    # https://github.com/actions/cache/blob/main/examples.md#python---pipenv
    - uses: actions/cache@v2
      with:
        path: ~/.local/share/virtualenvs
        # The pipenv location, e.g., ~/.local/share/virtualenvs/proj-zd-Sqvsw
        # is based on a hash of the absolute path of the Pipfile, so
        # it will be reused between CI runs.
        #
        # But it contains symlinks to $pythonLocation set by
        # @actions/setup-python, which can break when the CI host minor
        # version of python is upgraded, e.g., 3.9.2 â†’ 3.9.3, so add it to
        # the cache key.
        key: ${{ runner.os }}-pipenv-${{ env.pythonLocation }}-${{ hashFiles('Pipfile.lock') }}
        restore-keys: |
          ${{ runner.os }}-pipenv-${{ env.pythonLocation }}

    - name: ðŸ“¥ Install dependencies
      run: |
        pipenv install --dev
        # Install pytest plugin to show failed tests on the web
        pipenv run pip install pytest-github-actions-annotate-failures
    - name: Do LFS checkout
      # actions/checkout@v2 has a `with: lfs: true` option, but it only
      # knows how to talk to GitHubâ€™s LFS server.
      #
      # These actions are automatic if you have run `git lfs install`
      # even once on your dev machine.
      run: git lfs install --local && git lfs fetch && git lfs checkout
    - name: ðŸ§¶ Run linters/static-analysis
      run: |
        pipenv run mypy CreeDictionary
    - name: ðŸ©º Run unit tests
      env:
        DEBUG: "True"
      run: pipenv run test -v --cov=CreeDictionary --cov-report=xml
    - name: ðŸ“¤ Upload Codecov coverage report
      uses: codecov/codecov-action@v1
      with:
        fail_ci_if_error: true

  # Runs Cypress acceptance tests
  integration-test:
    runs-on: ubuntu-16.04

    steps:
    - uses: actions/checkout@v2
    - name: ðŸ Set up Python ${{ env.ACTIONS_PYTHON_VERSION }}
      uses: actions/setup-python@v2
      with:
        python-version: ${{ env.ACTIONS_PYTHON_VERSION }}
    - name: Setup Node ${{ env.ACTIONS_NODE_VERSION }}
      uses: actions/setup-node@v1
      with:
        node-version: ${{ env.ACTIONS_NODE_VERSION }}
    - name: ðŸ–¥ Install system dependencies
      run: sudo apt-get install -y libfoma0 libgtk2.0-0 libgtk-3-0 libgbm-dev libnotify-dev libgconf-2-4 libnss3 libxss1 libasound2 libxtst6 xauth xvfb
    - name: â˜¤ Install pipenv
      run: python3 -m pip install pipenv

    # This started out life as a copy-paste from
    # https://github.com/actions/cache/blob/main/examples.md#python---pipenv
    - uses: actions/cache@v2
      with:
        path: ~/.local/share/virtualenvs
        # The pipenv location, e.g., ~/.local/share/virtualenvs/proj-zd-Sqvsw
        # is based on a hash of the absolute path of the Pipfile, so
        # it will be reused between CI runs.
        #
        # But it contains symlinks to $pythonLocation set by
        # @actions/setup-python, which can break when the CI host minor
        # version of python is upgraded, e.g., 3.9.2 â†’ 3.9.3, so add it to
        # the cache key.
        key: ${{ runner.os }}-pipenv-${{ env.pythonLocation }}-${{ hashFiles('Pipfile.lock') }}
        restore-keys: |
          ${{ runner.os }}-pipenv-${{ env.pythonLocation }}

    - name: ðŸ“¥ Install Python dependencies
      run: |
        pipenv install --dev
    - name: Do LFS checkout
      # actions/checkout@v2 has a `with: lfs: true` option, but it only
      # knows how to talk to GitHubâ€™s LFS server.
      #
      # These actions are automatic if you have run `git lfs install`
      # even once on your dev machine.
      run: git lfs install --local && git lfs fetch && git lfs checkout
    - name: ðŸ“¥ Install Node dependencies
      run: npm ci
    - name: ðŸ›‘ Halt tests if Cypress tests are marked as '.only'
      run: npm run stop-only
    - name: ðŸ— Build frontend
      run: npm run build
    - name: ðŸŒ² Run Cypress tests
      env:
        DEBUG: "True"
        # NOTE: only set on the upstream repo, i.e., UAlbertaALTLab/cree-intelligent-dictionary
        CYPRESS_RECORD_KEY: "${{ secrets.CYPRESS_RECORD_KEY }}"
      run: |
        # Enables uploading test runs to Cypress Dashboard:
        if [ -n "$CYPRESS_RECORD_KEY" ] ; then export CYPRESS_OPTS="--key $CYPRESS_RECORD_KEY" ; fi
        npm run test:ci

  build-docker-image:
    runs-on: ubuntu-20.04

    # Only build the Docker Image when we're deploying!
    needs:
     - should-deploy 
    if: needs.should-deploy.outputs.should-run == 'true'

    steps:
    - name: Login to GitHub Container Registry
      uses: docker/login-action@v1
      with:
        registry: ghcr.io
        username: ${{ github.repository_owner }}
        password: ${{ secrets.GHCR_PERSONAL_ACCESS_TOKEN }}
    - uses: actions/checkout@v2
    - name: Build and push Docker images
      uses: docker/build-push-action@v2
      with:
        # build-push-action with the default â€˜git contextâ€™ ignores the
        # .dockerignore file
        # https://github.com/docker/build-push-action/issues/182
        context: .
        file: docker/Dockerfile
        push: true
        # hopefully this will speed up builds and save disk space by
        # sharing layers with the existing docker image, where possible
        cache-from: |
          type=registry,ref=ghcr.io/ualbertaaltlab/itwewina.altlab.app:latest
        tags: |
          ghcr.io/ualbertaaltlab/itwewina.altlab.app:${{ github.sha }}

  trigger-deployment:
    runs-on: ubuntu-20.04

    needs:
    - should-deploy
    - unit-test
    - integration-test
    - build-docker-image

    if: needs.should-deploy.outputs.should-run == 'true'

    steps:
    - name: Login to GitHub Container Registry
      uses: docker/login-action@v1
      with:
        registry: ghcr.io
        username: ${{ github.repository_owner }}
        password: ${{ secrets.GHCR_PERSONAL_ACCESS_TOKEN }}
    - uses: actions/checkout@v2
    - name: ðŸ Set up Python ${{ env.ACTIONS_PYTHON_VERSION }}
      uses: actions/setup-python@v2
      with:
        python-version: ${{ env.ACTIONS_PYTHON_VERSION }}
    - name: Install requests
      run: pip install requests
    - name: Update tag
      run: docker/copy-registry-tag ${{ github.sha }} latest
      env:
        GHCR_PERSONAL_ACCESS_TOKEN: ${{ secrets.GHCR_PERSONAL_ACCESS_TOKEN }}
    - name: send HTTP request to deploy.altlab.dev webhook
      # Be careful with spacing here.
      #
      # What https://yaml-multiline.info *doesnâ€™t* warn you about: although
      # `>-` means â€œreplace newlines with spaces,â€ if you have an extra
      # space on the next line, the newline gets preserved!
      #
      # So although
      #
      #     foo: >-
      #       a
      #       a
      #
      # means `{ "foo": "a a" }`,
      #
      #     foo: >-
      #       a
      #        a
      #
      # turns into `{ "foo": "a\n a" }` !
      run: >-
        curl -X POST https://deploy.altlab.dev/itwewina --fail
        -d '{ "secret": "${{ secrets.DEPLOY_ALTLAB_DEV_ITWEWINA_KEY }}" }'
        -H 'Content-Type: application/json'
